name: Health Checks

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'supabase/**'
  push:
    branches: [main, develop]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'supabase/**'

jobs:
  health-checks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Setup Checkly CLI
        run: |
          npm install -g @checkly/cli@latest
          echo "Checkly CLI version: $(checkly --version)"
          
      - name: Run local health checks
        run: |
          echo "ğŸ” Running local health checks..."
          
          # Check if admin app builds
          echo "ğŸ“± Checking admin app build..."
          cd apps/admin
          npm run build
          echo "âœ… Admin app builds successfully"
          
          # Check if mobile app builds
          echo "ğŸ“± Checking mobile app build..."
          cd ../order-mobile
          npm run build
          echo "âœ… Mobile app builds successfully"
          
          cd ../..
          
      - name: Run Checkly health checks
        env:
          CHECKLY_API_KEY: ${{ secrets.CHECKLY_API_KEY }}
          ADMIN_URL: ${{ secrets.ADMIN_URL }}
          MOBILE_URL: ${{ secrets.MOBILE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "ğŸ§ª Running Checkly health checks..."
          
          # Deploy checks to Checkly
          checkly deploy --dry-run
          
          # Run health checks
          checkly test --reporter=github
          
      - name: Check deployment readiness
        run: |
          echo "ğŸš€ Checking deployment readiness..."
          
          # Check if both apps are ready for deployment
          if [ -d "apps/admin/dist" ] && [ -d "apps/order-mobile/dist" ]; then
            echo "âœ… Both apps are ready for deployment"
          else
            echo "âŒ Apps are not ready for deployment"
            exit 1
          fi
          
      - name: Run migration checks
        run: |
          echo "ğŸ—„ï¸ Running migration checks..."
          npm run check:migrations
          
      - name: Check for breaking changes
        run: |
          echo "ğŸ” Checking for breaking changes..."
          
          # Check for TypeScript errors
          echo "ğŸ“ Checking TypeScript compilation..."
          npx tsc --noEmit --project apps/admin/tsconfig.json
          npx tsc --noEmit --project apps/order-mobile/tsconfig.json
          echo "âœ… No TypeScript errors"
          
          # Check for linting errors
          echo "ğŸ” Checking linting..."
          npm run lint
          echo "âœ… No linting errors"
          
      - name: Summary
        run: |
          echo "ğŸ‰ Health checks completed successfully!"
          echo "âœ… Admin app: Ready"
          echo "âœ… Mobile app: Ready"
          echo "âœ… Database: Ready"
          echo "âœ… No breaking changes detected"
